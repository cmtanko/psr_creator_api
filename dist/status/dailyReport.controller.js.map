{"version":3,"sources":["../../src/status/dailyReport.controller.js"],"names":["router","post","req","res","query","body","url","username","reponame","get","method","headers","token","then","data","status","commits","repoDatas","promises","forEach","c","createdDate","created_at","format","queryDate","date","repoData","type","commit","toLowerCase","indexOf","commitMessage","message","committedBy","author","email","committedDate","push","payload","pull_request","isArray","all","result","results","onSuccess","send","catch","getGitCommitsReport","successFn","reportDatas","reportData","taskId","getCleanSplittedData","taskTitle","taskTimeSpent","getTimeInMins","taskStatus","getProjectStatus","mergedCommitsDetail","i","length","j","isUnique","finalCommitsReport","each","a","undefined","noAutoGeneratedCommitsReport","getUserList","userList","r","includes","userDatas","commitsByUsers","newObject","counter","totalTimeSpent","id","Math","round"],"mappings":";;;;;;AAAA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;AAEA,IAAMA,SAAS,sBAAf;AACA;;;;;;;;;;;;;;;AAeA;;;;;;;;;;;;;;;;;;;;;AAqBAA,OAAOC,IAAP,CAAY,GAAZ,EAAiB,UAACC,GAAD,EAAMC,GAAN,EAAc;AAC9B,KAAIC,QAAQF,IAAIG,IAAhB;AACA,KAAIC,MAAM,kCAAkCF,MAAMG,QAAxC,GAAmD,GAAnD,GAAyDH,MAAMI,QAA/D,GAA0E,sBAApF;AACA,iBAAMC,GAAN,CAAUH,GAAV,EACC;AACCI,UAAQ,KADT;AAECC,WAAS,EAAE,iBAAiB,WAAWP,MAAMQ,KAApC;AAFV,EADD,EAKEC,IALF,CAKO,UAACC,IAAD,EAAU;AAChB,MAAIA,KAAKC,MAAL,KAAgB,GAApB,EAAyB;AACxB,OAAIC,UAAU,iBAAEP,GAAF,CAAMK,IAAN,EAAY,MAAZ,CAAd;AACA,OAAIG,YAAY,EAAhB;AACA,OAAIC,WAAW,EAAf;;AAEAF,WAAQG,OAAR,CAAgB,UAACC,CAAD,EAAO;AACtB,QAAIC,cAAc,sBAAOD,EAAEE,UAAT,EAAqBC,MAArB,CAA4B,YAA5B,CAAlB;AACA,QAAIC,YAAY,sBAAOpB,MAAMqB,IAAb,EAAmBF,MAAnB,CAA0B,YAA1B,CAAhB;AACA,QAAIG,WAAW,EAAf;;AAEA;AACA,QAAIL,gBAAgBG,SAAhB,IAA6BJ,EAAEO,IAAF,KAAW,WAA5C,EAAyD;AACxD,SAAIC,SAAS,iBAAEnB,GAAF,CAAMW,CAAN,EAAS,oBAAT,KAAkC,EAA/C;AACA,SAAI,iBAAEX,GAAF,CAAMmB,MAAN,EAAc,SAAd,EAAyBC,WAAzB,GAAuCC,OAAvC,CAA+C,OAA/C,MAA4D,CAAC,CAAjE,EAAoE;AACnE,UAAIJ,YAAW;AACdK,sBAAeH,OAAOI,OADR;AAEdC,oBAAaL,OAAOM,MAAP,CAAcC,KAFb;AAGdC,sBAAehB,EAAEE;AAHH,OAAf;AAKAL,gBAAUoB,IAAV,CAAeX,SAAf;AACA;AACD;;AAED;AACA,QAAIL,gBAAgBG,SAAhB,IAA6BJ,EAAEO,IAAF,KAAW,kBAA5C,EAAgE;AAC/DT,cAASmB,IAAT,CAAc,gBAAM5B,GAAN,CAAU,iBAAEA,GAAF,CAAMW,EAAEkB,OAAF,CAAUC,YAAhB,EAA8B,aAA9B,CAAV,EACb;AACC7B,cAAQ,KADT;AAEC8B,eAAS,IAFV;AAGC7B,eAAS,EAAE,iBAAiB,WAAWP,MAAMQ,KAApC;AAHV,MADa,CAAd;AAOA;AACD,IA5BD,EA4BGK,SA5BH;;AA8BA,mBAAMwB,GAAN,CAAUvB,QAAV,EACEL,IADF,CACO,UAAC6B,MAAD,EAAY;AACjBA,WAAOvB,OAAP,CAAe,UAACL,IAAD,EAAU;AACxB,SAAI6B,UAAU7B,KAAKA,IAAnB;AACA,SAAIY,WAAW;AACdK,qBAAeY,QAAQ,CAAR,EAAWf,MAAX,CAAkBI,OADnB;AAEdC,mBAAaU,QAAQ,CAAR,EAAWf,MAAX,CAAkBM,MAAlB,CAAyBC,KAFxB;AAGdC,qBAAeO,QAAQ,CAAR,EAAWf,MAAX,CAAkBM,MAAlB,CAAyBT;AAH1B,MAAf;AAKAR,eAAUoB,IAAV,CAAeX,QAAf;AACA,KARD;AASAkB,cAAU3B,SAAV,EAAqBd,GAArB;AACA,IAZF;AAaA,GAhDD,MAgDO;AACNA,OAAI0C,IAAJ,CAAS,EAAE,SAAS,0BAA0B/B,IAArC,EAAT;AACA;AACD,EAzDD,EAyDGgC,KAzDH,CAyDS,UAAChC,IAAD,EAAU;AAClBX,MAAI0C,IAAJ,CAAS,EAAE,SAAS,0BAA0B/B,IAArC,EAAT;AACA,EA3DD;AA4DA,CA/DD;;AAiEA,IAAMiC,sBAAsB,SAAtBA,mBAAsB,CAAC9B,SAAD,EAAY+B,SAAZ,EAA0B;AACrD,KAAIC,cAAc,EAAlB;AACAhC,WAAUE,OAAV,CAAkB,UAACC,CAAD,EAAO;AACxB,MAAIW,gBAAgB,iBAAEtB,GAAF,CAAMW,CAAN,EAAS,eAAT,KAA6B,EAAjD;AACA,MAAI8B,aAAa;AAChBjB,gBAAab,EAAEa,WAAF,IAAiB,EADd;AAEhBG,kBAAehB,EAAEgB,aAAF,IAAmB,EAFlB;AAGhBe,WAAQ,sBAAmBC,oBAAnB,CAAwCrB,aAAxC,EAAuD,OAAvD,CAHQ;AAIhBsB,cAAW,sBAAmBD,oBAAnB,CAAwCrB,aAAxC,EAAuD,IAAvD,CAJK;AAKhBuB,kBAAe,sBAAmBC,aAAnB,CAAiC,sBAAmBH,oBAAnB,CAAwCrB,aAAxC,EAAuD,IAAvD,CAAjC,CALC;AAMhByB,eAAY,sBAAmBC,gBAAnB,CAAoC,sBAAmBL,oBAAnB,CAAwCrB,aAAxC,EAAuD,IAAvD,CAApC;AANI,GAAjB;AAQAkB,cAAYZ,IAAZ,CAAiBa,UAAjB;AACA,EAXD,EAWGD,WAXH;;AAaA;AACA,KAAIS,sBAAsB,EAA1B;AACA,MAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIV,YAAYW,MAAhC,EAAwCD,GAAxC,EAA6C;AAC5C,OAAK,IAAIE,IAAIF,IAAI,CAAjB,EAAoBE,IAAIZ,YAAYW,MAApC,EAA4CC,GAA5C,EAAiD;AAChD,OAAIZ,YAAYU,CAAZ,EAAeR,MAAf,KAA0BF,YAAYY,CAAZ,EAAeV,MAA7C,EAAqD;AACpDF,gBAAYU,CAAZ,EAAeN,SAAf,GAA2BJ,YAAYY,CAAZ,EAAeR,SAA1C;AACAJ,gBAAYU,CAAZ,EAAeL,aAAf,GAA+BL,YAAYU,CAAZ,EAAeL,aAAf,GAA+BL,YAAYY,CAAZ,EAAeP,aAA7E;AACAL,gBAAYY,CAAZ,EAAeC,QAAf,GAA0B,KAA1B;AACA;AACD;AACDJ,sBAAoBrB,IAApB,CAAyBY,YAAYU,CAAZ,CAAzB;AACA;;AAED;AACA,KAAII,qBAAqB,EAAzB;AACA,kBAAEC,IAAF,CAAON,mBAAP,EAA4B,UAACO,CAAD,EAAO;AAClC,MAAIA,EAAEH,QAAF,KAAeI,SAAnB,EAA8B;AAC7BH,sBAAmB1B,IAAnB,CAAwB4B,CAAxB;AACA;AACD,EAJD;;AAMA;AACA,KAAIE,+BAA+B,EAAnC;AACA,kBAAEH,IAAF,CAAOD,kBAAP,EAA2B,UAACE,CAAD,EAAO;AACjC,MAAIA,EAAEhC,WAAF,KAAkB,QAAtB,EAAgC;AAC/BkC,gCAA6B9B,IAA7B,CAAkC4B,CAAlC;AACA;AACD,EAJD;AAKAjB,WAAUmB,4BAAV;AACA,CA5CD;;AA8CA,IAAMC,cAAc,SAAdA,WAAc,CAACnD,SAAD,EAAY+B,SAAZ,EAA0B;AAC7C,KAAIqB,WAAW,EAAf;AACApD,WAAUE,OAAV,CAAkB,UAACmD,CAAD,EAAO;AACxB,MAAI,iBAAE7D,GAAF,CAAM6D,CAAN,EAAS,aAAT,CAAJ,EAA6B;AAC5B,OAAI,CAAC,iBAAEC,QAAF,CAAWF,QAAX,EAAqBC,EAAErC,WAAvB,CAAD,IAAwCqC,EAAErC,WAAF,CAAcJ,WAAd,OAAgC,QAA5E,EAAsF;AACrFwC,aAAShC,IAAT,CAAciC,EAAErC,WAAhB;AACA;AACD;AACD,EAND,EAMGoC,QANH;AAOArB,WAAUqB,QAAV;AACA,CAVD;;AAYA,IAAMzB,YAAY,SAAZA,SAAY,CAAC3B,SAAD,EAAYd,GAAZ,EAAoB;AACrC4C,qBAAoB9B,SAApB,EACC,UAACD,OAAD,EAAa;AACZoD,cAAYpD,OAAZ,EAAqB,UAACwD,SAAD,EAAe;AACnC,OAAIC,iBAAiB,EAArB;AACAD,aAAUrD,OAAV,CAAkB,UAAC8C,CAAD,EAAO;AACxB,QAAIS,YAAY;AACf,aAAQT,CADO;AAEf,gBAAW;AAFI,KAAhB;AAIA,QAAIU,UAAU,CAAd;AACA,QAAIC,iBAAiB,CAArB;;AAEA5D,YAAQG,OAAR,CAAgB,UAACmD,CAAD,EAAO;AACtBM,uBAAmBN,EAAEhB,aAAF,GAAkB,EAArC;AACA,SAAIW,MAAMK,EAAErC,WAAZ,EAAyB;AACxBqC,QAAEO,EAAF,GAAOF,SAAP;AACAD,gBAAU,SAAV,EAAqBrC,IAArB,CAA0BiC,CAA1B;AACAI,gBAAU,WAAV,IAAyBI,KAAKC,KAAL,CAAWH,cAAX,CAAzB;AACA;AACD,KAPD,EAOGF,SAPH;AAQAD,mBAAepC,IAAf,CAAoBqC,SAApB;AACA,IAjBD,EAiBGD,cAjBH;;AAmBAtE,OAAI0C,IAAJ,CAAS,EAAE,kBAAkB4B,cAApB,EAAoC,aAAaxD,SAAjD,EAAT;AACA,GAtBD;AAuBA,EAzBF,EA0BC,UAACH,IAAD,EAAU;AACTX,MAAI0C,IAAJ,CAAS,YAAY/B,IAArB;AACA,EA5BF;AA6BA,CA9BD;;kBAgCed,M","file":"dailyReport.controller.js","sourcesContent":["import { Router } from 'express';\nimport axios from 'axios';\nimport _ from 'lodash';\nimport moment from 'moment';\nimport dailyReportService from './dailyReport.service';\n\nconst router = Router();\n/**\n * @swagger\n * definitions:\n *   Status:\n *     properties:\n *       username:\n *         type: string\n *       reponame:\n *         type: string\n *       token:\n *         type: string\n *       date:\n *         type: string\n */\n\n/**\n * @swagger\n * /api/status:\n *   post:\n *     tags:\n *       - Report Generator\n *     description: Lists Github commits based on given date\n *     produces:\n *       - application/json\n *     parameters:\n *       - name: payload\n *         description: Github commits\n *         in: body\n *         required: true\n *         schema:\n *           $ref: '#/definitions/Status'\n *     responses:\n *       200:\n *         description: Successfully Listed\n */\n\nrouter.post('/', (req, res) => {\n\tlet query = req.body;\n\tlet url = 'https://api.github.com/repos/' + query.username + '/' + query.reponame + '/events?per_page=300';\n\taxios.get(url,\n\t\t{\n\t\t\tmethod: 'GET',\n\t\t\theaders: { 'Authorization': 'token ' + query.token }\n\t\t}\n\t).then((data) => {\n\t\tif (data.status === 200) {\n\t\t\tlet commits = _.get(data, 'data');\n\t\t\tlet repoDatas = [];\n\t\t\tlet promises = [];\n\n\t\t\tcommits.forEach((c) => {\n\t\t\t\tlet createdDate = moment(c.created_at).format('YYYY-MM-DD');\n\t\t\t\tlet queryDate = moment(query.date).format('YYYY-MM-DD');\n\t\t\t\tlet repoData = {};\n\n\t\t\t\t//IF PUSHEVENT TYPE\n\t\t\t\tif (createdDate === queryDate && c.type === 'PushEvent') {\n\t\t\t\t\tlet commit = _.get(c, 'payload.commits[0]') || [];\n\t\t\t\t\tif (_.get(commit, 'message').toLowerCase().indexOf('merge') === -1) {\n\t\t\t\t\t\tlet repoData = {\n\t\t\t\t\t\t\tcommitMessage: commit.message,\n\t\t\t\t\t\t\tcommittedBy: commit.author.email,\n\t\t\t\t\t\t\tcommittedDate: c.created_at\n\t\t\t\t\t\t};\n\t\t\t\t\t\trepoDatas.push(repoData);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t//IF PULLREQUESTEVENT TYPE\n\t\t\t\tif (createdDate === queryDate && c.type === 'PullRequestEvent') {\n\t\t\t\t\tpromises.push(axios.get(_.get(c.payload.pull_request, 'commits_url'),\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tmethod: 'GET',\n\t\t\t\t\t\t\tisArray: true,\n\t\t\t\t\t\t\theaders: { 'Authorization': 'token ' + query.token }\n\t\t\t\t\t\t}\n\t\t\t\t\t));\n\t\t\t\t}\n\t\t\t}, repoDatas);\n\n\t\t\taxios.all(promises)\n\t\t\t\t.then((result) => {\n\t\t\t\t\tresult.forEach((data) => {\n\t\t\t\t\t\tlet results = data.data;\n\t\t\t\t\t\tlet repoData = {\n\t\t\t\t\t\t\tcommitMessage: results[0].commit.message,\n\t\t\t\t\t\t\tcommittedBy: results[0].commit.author.email,\n\t\t\t\t\t\t\tcommittedDate: results[0].commit.author.date\n\t\t\t\t\t\t};\n\t\t\t\t\t\trepoDatas.push(repoData);\n\t\t\t\t\t}, this);\n\t\t\t\t\tonSuccess(repoDatas, res);\n\t\t\t\t});\n\t\t} else {\n\t\t\tres.send({ 'error': 'Unable to fetch data!' + data });\n\t\t}\n\t}).catch((data) => {\n\t\tres.send({ 'error': 'Unable to fetch data!' + data });\n\t});\n});\n\nconst getGitCommitsReport = (repoDatas, successFn) => {\n\tlet reportDatas = [];\n\trepoDatas.forEach((c) => {\n\t\tlet commitMessage = _.get(c, 'commitMessage') || '';\n\t\tlet reportData = {\n\t\t\tcommittedBy: c.committedBy || '',\n\t\t\tcommittedDate: c.committedDate || '',\n\t\t\ttaskId: dailyReportService.getCleanSplittedData(commitMessage, 'space'),\n\t\t\ttaskTitle: dailyReportService.getCleanSplittedData(commitMessage, '-m'),\n\t\t\ttaskTimeSpent: dailyReportService.getTimeInMins(dailyReportService.getCleanSplittedData(commitMessage, '-t')),\n\t\t\ttaskStatus: dailyReportService.getProjectStatus(dailyReportService.getCleanSplittedData(commitMessage, '-s'))\n\t\t};\n\t\treportDatas.push(reportData);\n\t}, reportDatas);\n\n\t// LETS MERGE COMMITS FOR SAME TASK, TIME SPENT IS ADDED, COMMIT MESSESS WOULD BE THE FIRST COMMIT\n\tlet mergedCommitsDetail = [];\n\tfor (let i = 0; i < reportDatas.length; i++) {\n\t\tfor (let j = i + 1; j < reportDatas.length; j++) {\n\t\t\tif (reportDatas[i].taskId === reportDatas[j].taskId) {\n\t\t\t\treportDatas[i].taskTitle = reportDatas[j].taskTitle;\n\t\t\t\treportDatas[i].taskTimeSpent = reportDatas[i].taskTimeSpent + reportDatas[j].taskTimeSpent;\n\t\t\t\treportDatas[j].isUnique = false;\n\t\t\t}\n\t\t}\n\t\tmergedCommitsDetail.push(reportDatas[i]);\n\t}\n\n\t// LETS REMOVE ALL THE NON-UNIQUE TASKS\n\tlet finalCommitsReport = [];\n\t_.each(mergedCommitsDetail, (a) => {\n\t\tif (a.isUnique === undefined) {\n\t\t\tfinalCommitsReport.push(a);\n\t\t}\n\t});\n\n\t// REMOVE MERGED COMMITS\n\tlet noAutoGeneratedCommitsReport = [];\n\t_.each(finalCommitsReport, (a) => {\n\t\tif (a.committedBy !== 'GitHub') {\n\t\t\tnoAutoGeneratedCommitsReport.push(a);\n\t\t}\n\t});\n\tsuccessFn(noAutoGeneratedCommitsReport);\n};\n\nconst getUserList = (repoDatas, successFn) => {\n\tlet userList = [];\n\trepoDatas.forEach((r) => {\n\t\tif (_.get(r, 'committedBy')) {\n\t\t\tif (!_.includes(userList, r.committedBy) && r.committedBy.toLowerCase() !== 'github') {\n\t\t\t\tuserList.push(r.committedBy);\n\t\t\t}\n\t\t}\n\t}, userList);\n\tsuccessFn(userList);\n};\n\nconst onSuccess = (repoDatas, res) => {\n\tgetGitCommitsReport(repoDatas,\n\t\t(commits) => {\n\t\t\tgetUserList(commits, (userDatas) => {\n\t\t\t\tlet commitsByUsers = [];\n\t\t\t\tuserDatas.forEach((a) => {\n\t\t\t\t\tlet newObject = {\n\t\t\t\t\t\t'user': a,\n\t\t\t\t\t\t'commits': []\n\t\t\t\t\t};\n\t\t\t\t\tlet counter = 1;\n\t\t\t\t\tlet totalTimeSpent = 0;\n\n\t\t\t\t\tcommits.forEach((r) => {\n\t\t\t\t\t\ttotalTimeSpent += (r.taskTimeSpent / 60);\n\t\t\t\t\t\tif (a === r.committedBy) {\n\t\t\t\t\t\t\tr.id = counter++;\n\t\t\t\t\t\t\tnewObject['commits'].push(r);\n\t\t\t\t\t\t\tnewObject['totalTime'] = Math.round(totalTimeSpent);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, newObject);\n\t\t\t\t\tcommitsByUsers.push(newObject);\n\t\t\t\t}, commitsByUsers);\n\n\t\t\t\tres.send({ 'commitsByUsers': commitsByUsers, \"repoDatas\": repoDatas });\n\t\t\t});\n\t\t},\n\t\t(data) => {\n\t\t\tres.send('Error: ' + data);\n\t\t});\n};\n\nexport default router;"]}